# Cypress Testing Guide

### Prerequisites

- Chrome internet browser (or Chromium with 'chrome' alias on Linux).
- Backend is running, and database populated with test data.
- Frontend is runnning, must be on `localhost:3000` port.

### Summary

We use [Cypress](https://learn.cypress.io/) for integration testing and [MailSlurp](https://www.mailslurp.com/) for email tesitng. Integration tests run locally with Chrome. In GitHub Action CI workflows, it runs against the staging backend. Cypress tests require the frontend running on `localhost:3000` port and backend running with populated database.

## Set-Up:

To obtain the `CYPRESS_MAIL_SLURP_API_KEY` and `CYPRESS_INBOX_ID` variables, you must create a Mailslurp account, navigate to your dashboard to obtain the API key, then create an Mailslurp inbox.

For `CYPRESS_PROJECT_ID`, get started with Cypress by [creating a Cypress project](https://docs.cypress.io/cloud/get-started/setup). Then use the project id generated in your project configuration file, as directed [here](https://docs.cypress.io/cloud/account-management/projects).

To set-up, configure the Cypress variables in `env.local`.

1. For `CYPRESS_PROJECT_ID`: [Get started with Cypress](https://docs.cypress.io/guides/cloud/getting-started) and use your [Cypress project ID](https://docs.cypress.io/guides/cloud/account-management/projects).
2. For `CYPRESS_MAIL_SLURP_API_KEY` and `CYPRESS_INBOX_ID`: Create a [Mailslurp account](https://www.mailslurp.com/), navigate to your dashboard to obtain the API key, then [create an Mailslurp inbox](https://docs.mailslurp.com/inboxes/).
3. For local Bloom Users: Create local Bloom users from your local frontend. You will need a public user, a super admin user, and 2 partner admin users. Directions in [configure-users.md](configure-users.md).

## Run Tests:

To run the tests, follow the instructions below:

1. Ensure prerequisites are met.
2. Ensure the local database contains users with emails matching those in the `env.local` file.
3. Ensure Chrome is available on your local machine.
4. Run Cypress:
   - run `yarn cypress` on your terminal to run tests in the browser.
   - for lower-spec computers and faster, head-less version of the tests (i.e. no visible browser), use the command `yarn cypress:headless`.
   - Run single tests at a time by running `./node_modules/.bin/cypress run --spec cypress/integration/example_test_PATH.cy.tsx`
5. Cypress will now open a new screen displaying the available test (this may take upto a minute the first the command runs).
6. Click on the test you'd like to run. This will open another Chrome window and the chosen test will now run.

## Test Coverage

A code coverage report can be generated by running `yarn cypress:coverage`. This will generate two reports:

1. A coverage summary in the terminal
2. An `index.html` page found in `./coverage` which provides details of what lines of code have or have not been covered by tests, and can be viewed in a browser
